# MGAA: Multi-Granular Adaptive Allocation fof Low-Rank Compression of LLMs

提出一个“**rank / 压缩率分配器**”：在给定整体压缩目标 $p_t$ 下，**跨子层（MHA vs FFN，甚至逐层）分配不同压缩率**，并且在**子层内部（Wq/Wk/Wv/Wo 或 up/gate/down）再分配不同 rank**，整个过程不需要下游任务评测，基本只靠两次前向统计量完成。Li 等 - 2025 - MGAA Multi-Granul…

------

## 1）基础优化目标回顾：矩阵级低秩近似的三类目标

对任意权重矩阵 $W\in\mathbb{R}^{d_{\text{out}}\times d_{\text{in}}}$，经典“逐矩阵压缩”把全局压缩拆成多个独立问题：

1. **直接权重重构（SVD）**

$$
\min_{L,R}\ \|W-LR\|_F^2
\tag{2}
$$

1. **加权权重重构（Activation-aware / weighted SVD）**
    给定可逆重要性矩阵 $S\in\mathbb{R}^{d_{\text{in}}\times d_{\text{in}}}$（由激活统计得到），

$$
\min_{L,R}\ \|WS - LRS\|_F^2
\tag{3}
$$

1. **特征空间重构（PCA/AFM 类）**
    给定输入激活 $X\in\mathbb{R}^{d_{\text{in}}\times L}$，

$$
\min_{L,R}\ \|WX - LRX\|_F^2
\tag{4}
$$

MGAA 的“分配器”可以插在（2）（3）（4）任意一种低秩方法前面：它做的不是改变上面这些目标的形式，而是回答：**每个子层、每个矩阵到底该用多大 rank（或压缩率）？**

------

## 2）MGAA 的核心：把“统一压缩率”改成“多粒度自适应分配”

### 2.1 为什么“统一 rank/统一压缩率”不合理

论文强调两点异质性：

- **子层间异质性**：不同子层对表示变换强度不同（有的层几乎是“轻微调整”，冗余更大；有的层变换很剧烈，更敏感）。
- **子层内矩阵异质性**：同一个子层里 Wq/Wk/Wv/Wo 的谱能量分布差别很大，固定相同 rank 会导致性能差异巨大；但如果让不同矩阵保持“相同能量保留比例”，性能更一致（表 1 的现象）。

因此 MGAA 设计两级分配：

- **Inter-sublayer**：按子层重要性分配压缩率 $p$
- **Intra-sublayer**：在给定该子层 rank 预算下，按能量分布给各矩阵分配 rank，使能量保留尽量一致

------

## 3）第一部分：子层级压缩率分配（Sublayer-wise Allocation）

### 3.1 子层重要性度量：输入输出余弦相似度

Transformer 子层通常是（Pre-LN 形式）：
$$
Y = \mathrm{LAYER}(\mathrm{LN}(X)) + X
\tag{1}
$$
MGAA 用子层**输入 $X$** 与**输出 $Y$** 的列向量余弦相似度来衡量“变换强度/重要性”：
$$
I=\frac{1}{L}\sum_{m=1}^{L}\frac{X_m^\top Y_m}{\|X_m\|_2\ \|Y_m\|_2}
\tag{12}
$$
直觉：

- $I$ 越大：输入输出越接近，子层变换更小，冗余更大 → 可以压得更狠
- $I$ 越小：变换更强，越重要 → 压缩应更保守

### 3.2 把重要性映射成压缩率：Z-score + 线性缩放

先对各子层 $I$ 做标准化：
$$
z=\frac{I-\mathbb{E}[I]}{\sqrt{\mathrm{Var}[I]}}
\tag{13}
$$
再用超参 $\alpha$ 控制“差异化强度”，并用 $p_t$ 做整体中心平移：
$$
p = \alpha\cdot z + p_t
= \alpha\left(\frac{I-\mathbb{E}[I]}{\sqrt{\mathrm{Var}[I]}}\right)+p_t
\tag{14}
$$
这里 $p$ 是该子层的“目标压缩率”（你也可以理解为该子层 rank 比例的反向量）。

- $\alpha$ 越大：不同子层的压缩率差异越大（更激进的分配）
- $p_t$ 保证整体压缩水平的中心值

### 3.3 结构修正：MHA 与 FFN 参数量不同导致“实际整体压缩率偏移”

直接用式(14)对子层分配，会忽略不同子层参数量差异。例如 LLaMA1 中 FFN 参数约是 MHA 的 $\beta\approx2$ 倍。

设：

- FFN 子层压缩率平均 $\mathbb{E}[p_{\text{ffn}}]$
- MHA 子层压缩率平均 $\mathbb{E}[p_{\text{mha}}]$

则“实际整体压缩率”近似：
$$
p_s = \frac{\mathbb{E}[p_{\text{ffn}}]\cdot \beta + \mathbb{E}[p_{\text{mha}}]}{\beta+1}
\tag{15}
$$
为了让最终整体压缩率严格匹配目标 $p_t$，他们做一次性平移校正：
$$
p \leftarrow p + (p_t - p_s)
\tag{16}
$$
到这里，你就得到每个子层最终的压缩率 $p$，从而得到该子层的 rank 预算（无论你后面用 SVD/ASVD/PCA/AFM 哪种分解器）。

------

## 4）第二部分：子层内矩阵 rank 分配（Energy-balanced Allocation）

这部分是 MGAA 更“像理论”的地方：他们用 PCA 的性质把“压缩损失”直接写成“被截断能量之和”，从而自然导出“能量保留一致 → 性能更一致”的策略。

### 4.1 以 PCA（特征空间低秩）为例：压缩损失 = 截断特征值之和

给定输入 $X$，输出 $Y=WX$。对输出自相关矩阵做特征分解：
$$
YY^\top = WX(WX)^\top = WXX^\top W^\top = U\Lambda U^\top
\tag{8}
$$
取前 $r$ 个特征向量 $U_r$，PCA 的低秩投影给出：
$$
WX \approx U_rU_r^\top WX = LRX
\tag{10}
$$
其中 $L=U_r,\ R=U_r^\top W$。

关键性质：压缩后的输出误差（在校准集上）满足
$$
\mathcal{L}
=\|U U^\top WX - U_rU_r^\top WX\|_F^2
=\mathrm{trace}(U_k\Lambda_k U_k^\top)
=\sum_{i=r+1}^{d_{\text{out}}}\lambda_i
\tag{11}
$$
所以：**给定 rank $r$，最小损失就是丢掉的特征值之和**。这和你之前分析 FLAT-LLM 的 “dropped eigenvalues sum = loss”在形式上是同构的，只是对象不同。

### 4.2 能量归一化 + 累积能量向量

由于不同矩阵的能量尺度不同，MGAA 用能量比例：
$$
\hat\lambda_j = \frac{\lambda_j}{\sum_{i=1}^{d_{\text{out}}}\lambda_i}
\tag{17}
$$
定义累积能量向量：
$$
c_i=\sum_{j=1}^{i}\hat\lambda_j,\quad
c=[c_1,\ldots,c_{d_{\text{out}}}]
\tag{18}
$$
若某矩阵保留 rank $r$，则其“能量保留比例”就是 $c_r$（越接近 1，保留越多）。

### 4.3 子层内的约束优化：在 rank 预算下让各矩阵能量保留尽量一致

对一个子层内矩阵集合 $T$（例如 MHA: $\{W_q,W_k,W_v,W_o\}$），设：

- 给矩阵 $W_a$ 分配 rank $r_a$
- 对应能量保留比例 $cr_a = c^{(a)}_{r_a}$
- 子层总 rank 预算 $R_{\text{budget}}$（来自该子层压缩率 $p$）

他们把分配写成：
$$
\max \sum_{a\in T} cr_a
\quad \text{s.t.}\quad
\sum_{a\in T} r_a \le R_{\text{budget}},
\ \ \forall a,b\in T:\ |cr_a-cr_b|<\varepsilon
\tag{19}
$$
含义：

- 在预算内，尽量让所有矩阵都保留尽可能高的能量；
- 同时强制“能量保留差距”不要太大（能量平衡），避免出现某个矩阵被压得能量很低从而成为瓶颈。

论文说这是典型凸优化，可用二分、动态规划、混合整数规划等解；工程上你也可以实现成“二分共同能量阈值 $\rho$”：

- 给定 $\rho$，每个矩阵取最小 $r_a$ 使得 $c^{(a)}_{r_a}\ge\rho$
- 看 $\sum_a r_a$ 是否超预算
- 二分 $\rho$ 找最大可行值
   这个实现非常直观，而且和式(19)的“能量平衡”精神一致。

### 4.4 对 weighted-SVD 类方法的适配：能量换成 $\sigma^2$

如果你用的是加权矩阵分解（式(3)），能量自然来自奇异值平方：
$$
\Sigma = \mathrm{diag}(\sigma_1,\ldots,\sigma_{d_{\text{out}}}),
\quad
\hat\sigma_j = \frac{\sigma_j^2}{\sum_i \sigma_i^2},
\quad
c_i=\sum_{j=1}^{i}\hat\sigma_j
\tag{20}
$$
这就是 MGAA “plug-and-play” 的关键：它不绑定某个分解器，只需要你告诉它“能量谱”。

------

## 5）完整 Step 实现流程（按 MGAA 的算法重写成可落地 pipeline）

输入：未压缩子层集合 $M$，整体目标压缩率 $p_t$，缩放系数 $\alpha$，校准集（任务无关文本/指令混合均可）

### Step 1：两次前向统计子层重要性

1. 在校准集上跑前向
2. 对每个子层拿到输入输出激活 $X,Y$
3. 计算余弦相似度重要性 $I$（式(12)）

### Step 2：把重要性映射成子层压缩率并做参数量修正

1. 对所有子层 $I$ 做 Z-score（式(13)）
2. 得到初始压缩率 $p=\alpha z+p_t$（式(14)）
3. 用 $\beta$ 计算整体实际压缩率 $p_s$（式(15)）
4. 做一次平移校正 $p\leftarrow p+(p_t-p_s)$（式(16)）

### Step 3：对子层内每个矩阵计算能量累积分布

对每个子层 $S\in M$，对其中每个矩阵 $W$：

- 若使用 PCA/AFM：统计输出特征，求 $YY^\top$ 的特征值，算 $c$（式(8)(17)(18)）
- 若使用 weighted-SVD：对加权矩阵做 SVD，取 $\sigma^2$ 算 $c$（式(20)）

### Step 4：解子层内 rank 分配

1. 根据子层压缩率 $p$ 得到该子层预算 $R_{\text{budget}}$（rank-budget 的换算你可沿用你当前框架，例如按参数量预算或按论文常用的 rank 公式）
2. 解式(19) 或用“二分共同能量阈值”的近似算法得到 $\{r_a\}$

### Step 5：调用任意低秩分解器进行真正压缩

对每个矩阵 $W_a$ 用你选择的方法（SVD/ASVD/AWSVD/PCA/AFM/联合分解等）在 rank $r_a$ 下生成 $L_a,R_a$，替换原矩阵。

------

## 6）MGAA 与你关心的 SVD-LLM v2 / SAES-SVD 的主要理论区别

1. **MGAA 解决的是“预算如何分配”，不是“如何分解更准”**

- SVD-LLM v2 / SAES-SVD：核心在“截断误差如何影响输出/如何抑制累计误差”，属于“分解器本身”的改造。
- MGAA：核心在“谁更该省、谁更该留”，属于“全局资源调度器”。

1. **MGAA 的误差代理更偏统计与谱能量，而不是误差传播模型**

- MGAA：用余弦相似度做子层重要性；用能量谱（$\lambda$ 或 $\sigma^2$）做矩阵内分配；本质是“能量/变换强度代理”。
- SAES-SVD：显式建模局部误差与累计误差，并做自适应抑制；更接近“误差动力学”。

1. **MGAA 是天然可插拔模块**
    它不依赖下游验证集，也不要求反向梯度；只要你能给出“重要性分数”和“能量谱”，就能给任何低秩方法输出 rank 方案。

------

## 7）一些可延展的 idea（只给方向，不展开成详细融合方案）

1. **把“子层重要性”从余弦相似度升级为“误差传播风险分数”**
    MGAA 的 $I$ 衡量的是“变换强度”，但不直接对应“压缩误差会不会向后爆炸”。你可以把 SAES-SVD 的累计误差视角做成一个 proxy（例如：该层输出对后续层的敏感度/放大系数），替换或融合到 $I$ 里，让分配更贴近压缩稳定性。
2. **把“能量平衡约束”改成“任务加权能量平衡”**
    现在是 $|cr_a-cr_b|<\varepsilon$。你可以按矩阵类型设不同权重（例如让 $W_v, W_o$ 更保守），变成：

$$
|w_a cr_a - w_b cr_b| < \varepsilon
$$

或把目标改成最小化能量差的方差。

1. **在子层内做“联合谱”而不是逐矩阵谱**
    比如 MHA 的 $W_q,W_k$ 经常被联合分解（行拼接）。MGAA 的能量平衡可从“矩阵级”扩展到“联合块级”：对拼接后的大矩阵取谱能量，再分摊回子矩阵，从而更适配 Joint Rank-k 这类方法。
2. **将式(19)从硬约束改成软约束并引入闭式解近似**
    把能量平衡从 $\ell_\infty$ 约束改为惩罚项：

$$
\max \sum_a cr_a - \gamma \sum_{a<b}(cr_a-cr_b)^2
$$

然后用拉格朗日或坐标下降给出更快的近似求解器（比 MIP/DP 更轻）。

1. **把“二分共同能量阈值 $\rho$”与 SVD-LLM v2 的截断阈值联动**
    SVD-LLM v2 的核心是“截断策略”；MGAA 的核心是“阈值/预算分配”。你可以把每层/每矩阵的 $\rho$ 当作一种“能量阈值”，再映射到 v2 的截断规则（例如对不同层设置不同的奇异值截断比例），形成一致的谱控制框架。