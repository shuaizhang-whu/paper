# FourierCompress：Layer-Aware Spectral Activation Compression for  Efficient and Accurate Collaborative LLM Inference

## 1）问题设定与原始优化目标：协同推理里的激活传输瓶颈

协同/拆分推理（client 跑前几层，server 跑后几层）在自回归解码中，每生成一个 token 都要传一次中间激活，通信量随输出长度线性增长。设 split 在第 $\ell$ 层后，客户端要传该层输出激活：
$$
A^{(\ell)}\in\mathbb{R}^{S\times D}
$$
其中 $S$ 是序列长度（tokens），$D$ 是隐藏维度。压缩方法的“朴素目标”就是在给定压缩率下，尽量减小重构误差：
$$
\min_{\mathcal C,\mathcal D}\ \|A-\hat A\| \quad \text{s.t.}\quad \mathrm{Size}(\mathcal C(A))\le \frac{1}{\rho}\mathrm{Size}(A)
$$
其中 $\mathcal C$ 是压缩器，$\mathcal D$ 是解压器，$\hat A=\mathcal D(\mathcal C(A))$，$\rho$ 是压缩倍率（越大压得越狠）。

传统方案（Top-k、SVD/QR）等价于在某个基上做稀疏/低秩近似，但它们把激活当“无结构张量”，不利用激活在 token 维和 hidden 维上的相关性。

------

## 2）关键观察：层间可压缩性不同，第一层激活最“低频集中”

论文把“where to split”和“how to compress”绑在一起：不是任何层都能高压缩，**越深层激活越高熵、越不平滑**，同样压缩率下误差更大、精度更掉；而第一层激活表现出明显的平滑结构，频谱能量集中在低频区域，因此更适合频域截断（页 4–5 的可视化与描述）。Ma 等 - 2025 - FourierCompress L…

这给出一个隐含的“层选择目标”：
$$
\ell^\star=\arg\min_\ell\ \mathbb{E}\big[ \mathrm{AccLoss}(\ell,\rho)\big]
\quad \text{或}\quad
\ell^\star=\arg\min_\ell\ \mathbb{E}\big[\|A^{(\ell)}-\hat A^{(\ell)}\| \big]
$$
在实验里，它结论性地选择 **第一层作为 split 点**，再做激活压缩。

------

## 3）改进后的目标：从“直接在原空间近似” → “频域低通截断 + 共轭对称重构”

### 3.1 频域表述：2D FFT 把激活当成二维信号

把激活矩阵 $A\in\mathbb{R}^{S\times D}$ 视作二维离散信号（token 轴 + hidden 轴），做 2D FFT 得到复频谱：
$$
\tilde A[u,v]
=\sum_{s=0}^{S-1}\sum_{d=0}^{D-1}A[s,d]\cdot e^{-j2\pi(\frac{us}{S}+\frac{vd}{D})}
$$
其中 $(u,v)$ 是二维频率坐标。Ma 等 - 2025 - FourierCompress L…

### 3.2 压缩操作：保留左上角低频块（矩形截断）

选两个截断阈值 $K_S\ll S,\ K_D\ll D$，仅保留低频块：
$$
\tilde A_{\text{keep}}=\tilde A[0:K_S,\ 0:K_D]
$$
压缩率（忽略复数存储细节）近似为：
$$
\rho \approx \frac{SD}{K_SK_D}
$$
直觉：低频块携带“平滑/共享结构”，高频多是 token-specific、neuron-specific 的细碎变化，丢掉影响小。

从优化角度看，这相当于把“在傅里叶基下的稀疏近似”固定为**结构化的 block sparsity**：
$$
\min_{\hat A}\ \|A-\hat A\|_F^2
\quad \text{s.t.}\quad
\mathrm{supp}(\mathcal F(\hat A))\subseteq \Omega_{K_S,K_D}
$$
其中 $\Omega_{K_S,K_D}=\{0\ldots K_S-1\}\times\{0\ldots K_D-1\}$，$\mathcal F$ 是 2D FFT。这个问题的最优解就是把频谱在 $\Omega$ 外置零再 IFFT（典型低通滤波/投影）。

### 3.3 重构：零填充 + 共轭对称（real signal 的冗余）

因为 $A$ 是实矩阵，其频谱满足共轭对称：
$$
\tilde A[u,v] = \tilde A^\ast[S-u,\ D-v]
$$
所以高频部分存在冗余。实际重构做法是：构造 $\tilde A_{\text{pad}}\in\mathbb{C}^{S\times D}$，把保留块放左上角，其余置零（并利用共轭对称填充需要的对称位置），再做 2D IFFT 得重构激活：
$$
\hat A[s,d]
=\frac{1}{SD}\sum_{u=0}^{S-1}\sum_{v=0}^{D-1}\tilde A_{\text{pad}}[u,v]\cdot e^{j2\pi(\frac{us}{S}+\frac{vd}{D})}
$$
Ma 等 - 2025 - FourierCompress L…

这一步的意义：它把“压缩-解压”完全变成 FFT/IFFT 的固定算子，非常适合硬件加速（DSP/FPGA/GPU 的 cuFFT）。

------

## 4）为什么它比 Top-k / SVD / QR 更适合“激活传输压缩”

你可以用“结构匹配”的角度理解：

- **Top-k**：在原坐标系做稀疏，破坏了 token 维与 hidden 维的空间一致性/连续性（论文强调会破坏激活的空间相干性）。
- **SVD/QR**：对激活做低秩分解，理论上是最优的 rank-$r$ 近似，但计算代价高（SVD/QR 在推理时每 token 做一次会非常慢），而且激活的结构未必是“低秩”主导，更可能是“低频平滑”主导。
- **FFT 截断**：复杂度近似 $O(SD\log(SD))$，且在早层激活低频能量高度集中时，误差更小。

它的“误差优势”可以用 Parseval 定理直观解释：在正交傅里叶基下，
$$
\|A-\hat A\|_F^2 \propto \sum_{(u,v)\notin\Omega} |\tilde A[u,v]|^2
$$
如果能量集中在低频，丢掉高频就几乎不损失能量。

------

## 5）Step 实现过程（从协同推理到压缩/重构）

下面按真实部署流程拆：

### Step 0：确定 split layer（层选择）

1. 在多个候选层 $\ell$ 上，固定目标精度损失阈值（例如“near-lossless”定义：精度下降 $\le 0.3\%$），测出每层能承受的最大压缩倍率 $\rho_\ell$；
2. 选择 $\ell^\star$（论文结论是第一层最优）。Ma 等 - 2025 - FourierCompress L…

### Step 1：客户端压缩（每次 token 解码都会执行）

给第一层输出激活 $A\in\mathbb{R}^{S\times D}$：

1. 2D FFT：$\tilde A=\mathrm{FFT2}(A)$
2. 取低频块：$\tilde A_{\text{keep}}=\tilde A[0:K_S,0:K_D]$
3. 发送：$\tilde A_{\text{keep}}$（以及必要的 $K_S,K_D,S,D$ 元信息；论文强调“位置隐式已知”，元信息很少）

### Step 2：服务器端重构

1. 构造零填充频谱 $\tilde A_{\text{pad}}$，把 $\tilde A_{\text{keep}}$ 放回左上角，其余置零，并利用共轭对称补齐需要的频率
2. IFFT：$\hat A=\mathrm{IFFT2}(\tilde A_{\text{pad}})\in\mathbb{R}^{S\times D}$
3. 用 $\hat A$ 作为 split 点输入，继续跑后续层直到输出 token。

### Step 3：压缩率如何控制（从倍率到 $K_S,K_D$）

目标倍率 $\rho$ 给定后，选 $K_S,K_D$ 满足 $K_SK_D\approx SD/\rho$。可以：

- 固定形状比例（例如 $K_S:S$ 与 $K_D:D$ 维持某个比值）
- 或按频谱能量分布自适应选（更接近“能量阈值”）

------

## 6）与 SVD-LLM v2 / SAES-SVD 的主要理论区别（你写新论文时怎么描述差异）

1. **压缩对象不同**

- SVD-LLM v2 / SAES-SVD：压的是权重 $W$，目的是让本地推理更快/更小；
- FourierCompress：压的是“传输的中间激活 $A$”，目的是省带宽与端到端时延。

1. **优化空间不同**

- SVD-LLM/SAES：主要在低秩子空间（奇异值截断、误差补偿、误差传播抑制）；
- FourierCompress：在傅里叶正交基里做结构化截断（低通投影），压缩性来自“早层激活的频谱稀疏”。

1. **误差形态不同**

- 低秩误差更像“子空间丢失”（丢掉某些奇异方向）；
- 频域误差更像“高频细节丢失”（平滑化/去噪），在早层可能反而起到正则化（论文甚至观察到某些设置下略微优于 baseline 的现象）。Ma 等 - 2025 - FourierCompress L…

1. **计算代价/硬件亲和性不同**

- SVD/QR 对激活做分解代价极高，不适合每 token 在线执行；
- FFT 是成熟硬件算子，易并行、易上 DSP/FPGA/cuFFT，论文强调其压缩耗时可远低于 Top-k 和 SVD 类。Ma 等 - 2025 - FourierCompress L…

------

## 7）一些可以延展的 idea（不展开到详细结合建议）

### idea 1：把“低频块截断”升级为“能量最优的频率掩码”

当前是固定左上角矩形块 $\Omega_{K_S,K_D}$。更强的做法是：
$$
\Omega^\star=\arg\min_{|\Omega|=M}\sum_{(u,v)\notin\Omega}|\tilde A[u,v]|^2
$$
即选能量最大的 $M$ 个频点（但会引入索引开销）；可以折中成“若干同心矩形/菱形/分带”的结构化 mask，兼顾能量最优与低元数据。

### idea 2：把 split layer 选择从经验验证变成“可计算指标”

论文用实验展示第一层最好。你可以尝试构造一个可计算的指标，例如

- 频谱能量集中度（低频能量占比）
- 或激活的二维总变差（TV）/平滑度
- 或不同样本之间的激活相似度
   把它做成一个预测式规则来选 split 点。

### idea 3：频域压缩可与“旋转/白化”结合，让频谱更集中

如果对激活先做一个轻量的正交变换 $R$（比如 learned rotation 或 PCA/whitening 的近似），再做 FFT 截断：
$$
A \mapsto AR \mapsto \mathrm{FFT2}(AR)
$$
目标是让能量更集中到低频块，从而同样 $\rho$ 下误差更低。这个方向会自然连到你熟悉的“whitening/rotation”思想。

### idea 4：把 token 维与 hidden 维的截断解耦成“自适应 $K_S,K_D$”

对不同 prompt/不同任务，token 维的平滑度和 hidden 维的平滑度可能不同。可设：
$$
K_S = f_S(\tilde A),\quad K_D=f_D(\tilde A)
$$
例如用低频能量达到阈值 $\tau$ 的最小 $K_S,K_D$。

### idea 5：用“频域误差传播”解释为何深层不可压，并提出抑制策略

深层激活高频更多，低通会伤语义。你可以从
$$
\|A-\hat A\|_F^2 \propto \sum_{(u,v)\notin\Omega}|\tilde A[u,v]|^2
$$
出发，把“高频能量增长”与“表示熵/任务特异性”联系起来，形成一个理论解释框架（也可用来指导混合策略：早层 FFT、后层改用别的轻压缩）。

